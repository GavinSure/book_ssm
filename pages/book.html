<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>图书列表</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet"
          href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="../plugins/sweetalert2-theme-bootstrap-4/bootstrap-4.min.css">
    <!-- Toastr -->
    <link rel="stylesheet" href="../plugins/toastr/toastr.min.css">
    <link rel="stylesheet" href="../plugins/fontawesome-free/css/all.min.css">
    <!-- Theme style --> ..
    <link rel="stylesheet" href="../css/adminlte.min.css">
    <link rel="stylesheet" href="../css/pagination.css">
</head>
<style>
    table td {
        vertical-align: middle !important;
    }
</style>
</head>
<body class="hold-transition sidebar-mini">
<div class="wrapper">
    <!-- Content Wrapper. Contains page content -->
    <div class="content-wrapper">
        <!-- Content Header (Page header) -->
        <section class="content-header">
            <div class="container-fluid">
                <div class="row mb-2">
                    <div class="col-sm-6">
                        <div class="btn-group">
                            <button type="button" class="btn btn-default" data-toggle="modal"
                                    data-target="#modal-default">新建图书
                            </button>
                            <button type="button" class="btn btn-default">批量删除</button>
                        </div>
                    </div>
                    <div class="col-sm-6">
                        <form id="searchForm">
                            <div class="input-group input-group-lg form-inline float-sm-right">
                                <select name="firstTypeId" class="form-control select2" style="font-size: 15px"
                                        id="firstTypeSelect" onclick="secondType()">
                                    <option value="-1" selected>请选择一级分类</option>
                                </select>
                                <select name="secondTypeId" class="form-control select2"
                                        style="font-size:15px;margin-left: 10px" id="secondTypeSelect">
                                    <option value="-1" selected>请选择二级分类</option>
                                </select>
                                <input name="param" type="search" id="search" class="form-control form-control-lg"
                                       placeholder="search" style="margin-left: 10px;">
                                <div class="input-group-append">
                                    <button type="button" class="btn btn-lg btn-default" id="searchBtn">
                                        <i class="fa fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div><!-- /.container-fluid -->
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">图书列表信息</h3>
                            </div>
                            <!-- /.card-header -->
                            <div class="card-body">
                                <table class="table table-bordered table-hover text-center table-striped">
                                    <thead>
                                    <tr>
                                        <th style="width: 10px">
                                            <input type="checkbox"/>
                                        </th>
                                        <th>图书id</th>
                                        <th>图书名称</th>
                                        <th>作者名称</th>
                                        <th>一级分类</th>
                                        <th>二级分类</th>
                                        <th>图书封面</th>
                                        <th>操作</th>
                                    </tr>
                                    </thead>
                                    <tbody id="contentBody">
                                    <tr>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>1</td>
                                        <td>
                                            <button class="btn btn-info fas fa-edit"></button>
                                            <button class="btn btn-danger fas fa-trash-alt"></button>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- /.card-body -->
                            <div class="card-footer clearfix">
                                <div id="pagination" style="float: right">
                                </div>
                            </div>
                        </div>
                        <!-- /.card -->
                    </div>
                </div>
            </div>
        </section>
        <!-- /.content -->
    </div>
    <!-- /.content-wrapper -->
    <footer class="main-footer">
        <div class="float-right d-none d-sm-block">
            <b>Version</b> 3.1.0
        </div>
        <strong>Copyright &copy; 2014-2021 <a href="https://adminlte.io">AdminLTE.io</a>.</strong> All rights
        reserved.
    </footer>

    <!-- Control Sidebar -->
    <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
    </aside>
    <!-- /.control-sidebar -->

    <!--modals-->
    <div class="modal fade" id="modal-default">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">操作图书</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form action="" class="form-horizontal" id="dataForm">
                        <div class="card-body">
                            <div class="form-group row">
                                <label for="bookName" class="col-sm-2 col-form-label">图书名称:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="bookName" id="bookName"
                                           placeholder="bookName">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="authorName" class="col-sm-2 col-form-label">作者名称:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" name="authorName" id="authorName"
                                           placeholder="authorName">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="bookType" class="col-sm-2 col-form-label">图书分类:</label>
                                <div class="col-sm-10">
                                    <select id="bookType" name="firstTypeId"  class="form-control select2" onchange="secondType2()"
                                            style="width: 40%; float: left;font-size: 15px">
                                        <option selected value="-1">请选择一级分类</option>
                                    </select>
                                    <select id="secondbookType" class="form-control select2" name="secondTypeId"
                                            style="width: 40%; float: left; margin-left: 10px">
                                        <option selected value="-1">请选择二级分类</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group row">
                                <label for="bookImage" class="col-sm-2 col-form-label">图书图片:</label>
                                <div class="col-sm-10">
                                    <label class="btn btn-success fas fa-plus"> 添加图片
                                        <input id="bookImage" type="file" name="uploadAvatar"
                                               style="display: none" accept="image/*">
                                    </label>
                                    <input type="hidden" name="imgUrl" id="imgUrl">
                                    <span id="uploadMsg"></span>
                                    <img src="" id="showUploadImage"
                                         style="width: 100px;height: 100px; margin-left: 20px;vertical-align: top"
                                         alt="图书图片">
                                </div>

                            </div>
                            <div class="form-group row">
                                <label for="description" class="col-sm-2 col-form-label">图书描述:</label>
                                <div class="col-sm-10">
											<textarea class="form-control" placeholder="请输入描述" name="description"
                                                      id="description" cols="60" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer justify-content-between">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveBtn">保存</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="../plugins/jquery/jquery.min.js"></script>
<!-- Bootstra..p 4 -->
<script src="../plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../plugins/sweetalert2/sweetalert2.min.js"></script>
<script src="../plugins/toastr/toastr.min.js"></script>
<!-- AdminLTE.. App -->
<script src="../js/adminlte.min.js"></script>
<script src="../js/jquery.pagination.js"></script>
</body>
<script>
    //发送请求之前，都要将token的数据放入请求头中  应该是一个全局函数
    $.ajaxSetup({
        global:true,
        beforeSend:function (xhr) {
            //获得token的数据
            let token=localStorage.getItem("token");
            if (!token){
                location.replace("../login.html")
            }else {
                xhr.setRequestHeader("Authorization", "Basic " + token);
            }
        }
    })

</script>
<script>
    //分页查询图书的信息
    let page = 1;
    let size = 5;
    let count;
    let search=null;
    let firstTypeId=-1;
    let secondTypeId=-1;

   $("#searchBtn").click(()=>{
       search=$("#search").val();
       firstTypeId=$("#firstTypeSelect option:selected").val();
       secondTypeId=$("#secondTypeSelect option:selected").val();
       findByPage();
   })


    findByPage();

    function findByPage() {
        $.get(`http://127.0.0.1:8080/book/findBookByPage`, {
            "page": page,
            "size": size,
            "search":search,
            "firstTypeId":firstTypeId,
            "secondTypeId":secondTypeId,
        }, response => {
            console.log(secondTypeId);
            let {
                status,
                msg,
                data
            } = response;

            if (status=="3333"){
                parent.location.replace("../login.html?error=noLogin")
            }
            let {
                total,
                list
            } = data;
            let infoStr = "";
            $.each(list, (index, book) => {
                infoStr += `<tr>
									<td><input type='checkbox'></td>
									<td>${book.bookId}</td>
									<td>${book.bookName}</td>
									<td>${book.authorName}</td>
									<td>${book.firstTypeName}</td>
									<td>${book.secondTypeName}</td>
									<td><img src='${book.imgUrl}' width='30px' height='40px'/></td>
									<td>
										<button class="btn btn-info fas fa-edit"></button>
										<button class="btn btn-danger fas fa-trash-alt"></button>
									</td>
								</tr>`;
            });
            $("#contentBody").html(infoStr);
            count = total;

            //加载插件
            showPage(total)

        });
    }

    function showPage(pageCount) {
        $("#pagination").pagination(pageCount, //分布总数量，必须参数
            {
                callback: pageCallback, //PageCallback() 为翻页调用次函数。
                prev_text: "« 上一页",
                next_text: "下一页 »",
                items_per_page: size, //每页展示固定数据 size
                num_edge_entries: 3, //两侧首尾分页条目数
                num_display_entries: 5, //连续分页主体部分分页条目数
                current_page: page - 1, //当前页索引
                load_first_page: false,
            });
    }

    function pageCallback(index) {
        //异步请求服务  查询指定page的数据
        page = index + 1;
        findByPage()
    }
</script>
<script>
        $.get(`http://127.0.0.1:8080/book/findFirstType`,{},response=>{
            let {
                status,
                msg,
                data
            }=response;
            console.log(response);
            let list=data;
            let info="";
            $.each(list,(index,bookType)=>{
                info+=`<option value="${bookType.typeId}">${bookType.typeName}</option>`;
            });
            $("#firstTypeSelect").append(info);
            $("#bookType").append(info);
        });


        function secondType() {
            let parentId=$("#firstTypeSelect option:selected").val();
            
            $.get(`http://127.0.0.1:8080/book/findSecondType`,{
                "parentId":parentId
            },response=>{
                let {
                    status,
                    msg,
                    data
                }=response;
                let list=data;
                let info="<option value=\"-1\" selected>请选择二级分类</option>";
                $.each(list,(index,bookType)=>{
                    info+=`<option value="${bookType.typeId}">${bookType.typeName}</option>`;
                });
                $("#secondTypeSelect").html(info);
            })
        }
        function secondType2() {
            let parentId=$("#bookType option:selected").val();
            $.get(`http://127.0.0.1:8080/book/findSecondType`,{
                "parentId":parentId
            },response=>{
                let {
                    status,
                    msg,
                    data
                }=response;
                let list=data;
                let info="<option value=\"-1\" selected>请选择二级分类</option>";
                $.each(list,(index,bookType)=>{
                    info+=`<option value="${bookType.typeId}">${bookType.typeName}</option>`;
                });
                $("#secondbookType").html(info);
            })

        }

</script>
<!--新增页面js-->
<script>
    $("#bookImage").change(function () {
        let uploadFile=this.files[0];
        let formData=new FormData();
        formData.append("image",uploadFile);  //传值为form表单里的值

        $.ajax({
            type:"post",
            url:"http://127.0.0.1:8080/book/imgupload",
            data:formData,
            dataType:"json",
            processData:false,
            contentType:false,
            success:function (response){
                let {
                    status,
                    msg,
                    data
                }=response;
                console.log(response);
                if (status==1001){
                    $("#showUploadImage").prop("src",data);
                    $("#uploadMsg").text("文件上传成功").css("color","green");
                    $("#imgUrl").val(data);
                }else {
                    $("#uploadMsg").text("文件上传失败").css("color","red");
                }
            }
        })
    })
    $("#saveBtn").click(function () {
        let info=$("#dataForm").serialize();
        console.log(info);
        $.post("http://127.0.0.1:8080/book/addOrUpdateBook",info,response=>{
            let {
                status,
                msg,
                data
            }=response;
            if (status==1001){
                alert("添加成功！");
                $("#modal-default").modal('hide');
            }else {
                alert(msg);
            }
        },"json")
    })
</script>
</html>
